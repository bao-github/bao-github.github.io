<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <title>password</title>
    <script src="./jquery-3.5.1.min.js"></script>
    <script src="./aes-3.1.2.js"></script>
    <script src="./common.js"></script>
    <script type="text/javascript">
      var wordEncrypt1 = function (word) {
        var key = CryptoJS.enc.Utf8.parse("12345678900000001234567890000000");
        var iv = CryptoJS.enc.Utf8.parse("1234567890000000");
        var srcs = CryptoJS.enc.Utf8.parse(word);
        var encrypted = CryptoJS.AES.encrypt(srcs, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        return encrypted.ciphertext.toString();
      };

      var deWordEncrypt1 = function (word) {
        var key = CryptoJS.enc.Utf8.parse("12345678900000001234567890000000");
        var iv = CryptoJS.enc.Utf8.parse("1234567890000000");
        var srcs = CryptoJS.enc.Base64.stringify(CryptoJS.enc.Hex.parse(word));
        var decrypted = CryptoJS.AES.decrypt(srcs, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        return decrypted.toString(CryptoJS.enc.Utf8);
      };

      var _r = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;", "/": "&#x2F;", "`": "&#x60;", "=": "&#x3D;" };
      var _p = function (e) {
        return String(e).replace(/[&<>"'`=/]/g, function (e) {
          return _r[e];
        });
      };

      var ajax = async function (url, method, body) {
        var params = {
          method: method,
          headers: { "Content-Type": "application/json;charset=UTF-8" },
        };
        if (body) {
          params.body = body;
        }
        var response = await Promise.race([
          fetch(url, params),
          new Promise(function (resolve, reject) {
            setTimeout(() => {
              resolve({
                json: function () {
                  return { message: "TIMEOUT" };
                },
              });
            }, 5 * 1000);
          }),
        ]);
        return response.json();
      };

      $(function () {
        $("#my-comm").append(comm_pages);
        (async function () {
          var myTextarea = $("#my-textarea");
          var myToken = $("#my-token");
          var myMask = $("#my-mask");
          var myPre = $("#my-pre");
          var myMsg = $("#my-msg");

          var owner = "NieShuBao";
          var repo = "sync-01";
          var path = "github-new-password.txt";
          var gitee_access_token = "";

          var get = function () {
            return ajax(
              `https://gitee.com/api/v5/repos/${owner}/${repo}/contents/${path}?access_token=${gitee_access_token}`,
              //
              "GET"
            );
          };

          var _alert_timer = null;
          var _alert = function (text) {
            myMsg.html(text);
            if (_alert_timer != null) clearTimeout(_alert_timer);
            _alert_timer = setTimeout(function () {
              myMsg.html("");
            }, 3000);
          };

          var localToken = window.localStorage.getItem("token");
          if (localToken != null) {
            gitee_access_token = localToken;
            //
            myMask.show();
            var getRes = await get();
            if (getRes.message) {
              _alert("GET : " + getRes.message);
            } else {
              if (getRes.content) {
                var data = deWordEncrypt1(decodeURIComponent(escape(atob(getRes.content))));
                myPre.html(_p(data));
                myTextarea.val(data);
              }
            }
            myMask.hide();
          }

          $("#my-set").click(function () {
            window.localStorage.setItem("token", "eabe0f21c0655c4a9e8e145c81a6" + myToken.val());
            window.location.reload();
          });

          $("#my-clear").click(function () {
            window.localStorage.removeItem("token");
            window.location.reload();
          });

          $("#my-edit").click(function () {
            $("#my-pre,#my-edit").hide();
            $("#my-textarea,#my-save").show();
          });

          $("#my-save").click(function () {
            (async function () {
              //
              myMask.show();
              var getRes = await get();
              if (getRes.message) {
                _alert("GET : " + getRes.message);
              } else {
                var putRes = await ajax(
                  `https://gitee.com/api/v5/repos/${owner}/${repo}/contents/${path}`,
                  //
                  "PUT",
                  JSON.stringify({
                    access_token: gitee_access_token,
                    content: btoa(unescape(encodeURIComponent(wordEncrypt1(myTextarea.val())))),
                    message: "update-" + new Date().toLocaleString(),
                    sha: getRes.sha,
                  })
                );
                if (putRes.message) {
                  _alert("PUT : " + putRes.message);
                } else {
                  _alert("OK");
                }
              }
              myMask.hide();
            })();
          });
        })();
      });
    </script>
    <style type="text/css">
      html,
      body {
        width: 100%;
        height: 100%;
      }
      body {
        margin: 0;
      }
      #app {
        padding: 5px;
        font-size: 0;
      }
      #app textarea {
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
        box-sizing: border-box;
        white-space: nowrap;
        line-height: 22px;
        font-size: 20px;
        overflow: auto;
        outline: none;
        resize: none;
        width: 100%;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div style="padding: 2px 0; font-size: 16px; text-align: center" id="my-comm"></div>
      <div style="padding: 2px 0">
        <input type="text" id="my-token" value="****" style="width: 100px; text-align: center" autocomplete="off" />
        <button id="my-set" style="width: 80px; margin-left: 4px">Set</button>
        <button id="my-clear" style="width: 80px; margin-left: 4px; color: #f00">Clear</button>
      </div>
      <div style="padding: 2px 0">
        <pre id="my-pre" style="font-size: 20px; overflow: auto"></pre>
        <textarea id="my-textarea" rows="25" style="display: none"></textarea>
      </div>
      <div style="padding: 2px 0">
        <button id="my-edit" style="width: 160px">Edit</button>
        <button id="my-save" style="width: 160px; display: none">Save</button>
      </div>
      <div style="padding: 2px 0">
        <span id="my-msg" style="color: #f00; padding: 0 10px; font-size: 14px; vertical-align: middle"></span>
      </div>
    </div>
    <div id="my-mask" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; display: none">
      <div style="position: absolute; top: 120px; left: 50%; margin-left: -45px; font-size: 0; border-radius: 4px; overflow: hidden">
        <img src="./loading.gif" />
      </div>
    </div>
  </body>
</html>
